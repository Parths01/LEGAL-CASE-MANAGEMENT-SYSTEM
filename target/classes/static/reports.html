<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Smart Legal CMS</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .page-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); margin-bottom: 24px; }
        .filter-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 24px; flex-wrap: wrap; }
        .filter-bar input, .filter-bar select, .filter-bar button { padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; }
        .filter-bar input { min-width: 150px; }
        .filter-bar button { background: linear-gradient(135deg, #0b1c2d, #1a3a52); color: white; border: none; cursor: pointer; font-weight: 600; }
        .chart-container { position: relative; height: 300px; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: linear-gradient(135deg, #f5f7fa, #c3cfe2); border-radius: 12px; padding: 20px; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #0b1c2d; }
        .stat-label { color: #666; font-size: 0.9rem; margin-top: 8px; }
        .export-btn { background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .export-btn:hover { background: #388e3c; }
        @media (max-width: 768px) { .main-content { margin-left: 0; } .sidebar { transform: translateX(-100%); } }
    </style>
</head>
<body class="dashboard-body">
    <div class="sidebar">
        <div class="sidebar-logo"><i class="fas fa-balance-scale"></i><h4>Legal CMS</h4></div>
        <ul class="sidebar-menu">
            <li><a href="admin-dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="cases.html"><i class="fas fa-folder-open"></i> Cases</a></li>
            <li><a href="advocates.html"><i class="fas fa-user-tie"></i> Advocates</a></li>
            <li><a href="clients.html"><i class="fas fa-users"></i> Clients</a></li>
            <li><a href="hearings.html"><i class="fas fa-gavel"></i> Hearings</a></li>
            <li><a href="documents.html"><i class="fas fa-file-alt"></i> Documents</a></li>
            <li><a href="invoices.html"><i class="fas fa-file-invoice-dollar"></i> Invoices</a></li>
            <li><a href="payments.html"><i class="fas fa-credit-card"></i> Payments</a></li>
            <li><a href="legal-notices.html"><i class="fas fa-envelope-open-text"></i> Legal Notices</a></li>
            <li><a href="reports.html" class="active"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1><i class="fas fa-chart-bar"></i> Reports & Analytics</h1>
            <div class="user-info">
                <div class="user-avatar">A</div>
                <div><strong id="userName">Admin</strong><br><small class="text-muted">Administrator</small></div>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>

        <div class="page-card">
            <div class="filter-bar">
                <label>Date Range:</label>
                <input type="date" id="dateFrom" value="">
                <input type="date" id="dateTo" value="">
                <button onclick="applyFilters()"><i class="fas fa-filter"></i> Apply Filters</button>
                <button class="export-btn" onclick="exportReport()"><i class="fas fa-download"></i> Export CSV</button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="stat-value" id="totalCases">0</div><div class="stat-label">Total Cases</div></div>
            <div class="stat-card"><div class="stat-value" id="activeCases">0</div><div class="stat-label">Active Cases</div></div>
            <div class="stat-card"><div class="stat-value" id="wonCases">0</div><div class="stat-label">Won Cases</div></div>
            <div class="stat-card"><div class="stat-value" id="totalRevenue">₹0</div><div class="stat-label">Total Revenue</div></div>
            <div class="stat-card"><div class="stat-value" id="pendingInvoices">0</div><div class="stat-label">Pending Invoices</div></div>
            <div class="stat-card"><div class="stat-value" id="totalAdvocates">0</div><div class="stat-label">Total Advocates</div></div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px;">
            <div class="page-card">
                <h3><i class="fas fa-chart-pie"></i> Cases by Status</h3>
                <div class="chart-container"><canvas id="caseStatusChart"></canvas></div>
            </div>
            <div class="page-card">
                <h3><i class="fas fa-chart-line"></i> Revenue Trend</h3>
                <div class="chart-container"><canvas id="revenueChart"></canvas></div>
            </div>
            <div class="page-card">
                <h3><i class="fas fa-chart-bar"></i> Advocate Performance</h3>
                <div class="chart-container"><canvas id="advocateChart"></canvas></div>
            </div>
            <div class="page-card">
                <h3><i class="fas fa-chart-area"></i> Invoice Status</h3>
                <div class="chart-container"><canvas id="invoiceStatusChart"></canvas></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/nav.js"></script>
    <script>
        let allCases = [], allInvoices = [], allAdvocates = [];
        let caseStatusChart, revenueChart, advocateChart, invoiceStatusChart;
        const token = localStorage.getItem('token');
        if (!token) { window.location.href = 'login.html'; }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
            setDefaultDates();
            loadAllData();
            initCharts();
        });

        function loadUserInfo() {
            const u = localStorage.getItem('userName');
            if (u) document.getElementById('userName').textContent = u;
        }

        function setDefaultDates() {
            const to = new Date();
            const fr = new Date();
            fr.setMonth(fr.getMonth() - 3);
            document.getElementById('dateFrom').valueAsDate = fr;
            document.getElementById('dateTo').valueAsDate = to;
        }

        async function loadAllData() {
            try {
                const headers = { 'Authorization': `Bearer ${token}` };
                const [casesRes, invoicesRes, advocatesRes] = await Promise.all([
                    fetch('/api/cases', { headers }),
                    fetch('/api/invoices', { headers }),
                    fetch('/api/advocates', { headers })
                ]);

                if (casesRes.status === 401) { localStorage.clear(); window.location.href = 'login.html'; return; }
                
                allCases = casesRes.ok ? await casesRes.json() : [];
                allInvoices = invoicesRes.ok ? await invoicesRes.json() : [];
                allAdvocates = advocatesRes.ok ? await advocatesRes.json() : [];

                updateStats();
                updateCharts();
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function updateStats() {
            document.getElementById('totalCases').textContent = allCases.length;
            document.getElementById('activeCases').textContent = allCases.filter(c => c.status === 'ACTIVE').length;
            document.getElementById('wonCases').textContent = allCases.filter(c => c.status === 'WON').length;
            
            const paidInvoices = allInvoices.filter(i => i.status === 'PAID').reduce((s, i) => s + (i.amount || 0), 0);
            document.getElementById('totalRevenue').textContent = '₹' + paidInvoices.toLocaleString('en-IN');
            document.getElementById('pendingInvoices').textContent = allInvoices.filter(i => i.status === 'ISSUED' || i.status === 'DRAFT').length;
            document.getElementById('totalAdvocates').textContent = allAdvocates.length;
        }

        function initCharts() {
            const ctx1 = document.getElementById('caseStatusChart')?.getContext('2d');
            const ctx2 = document.getElementById('revenueChart')?.getContext('2d');
            const ctx3 = document.getElementById('advocateChart')?.getContext('2d');
            const ctx4 = document.getElementById('invoiceStatusChart')?.getContext('2d');

            if (ctx1) {
                caseStatusChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: { labels: ['Active', 'Won', 'Lost', 'Settled', 'Closed'], datasets: [{ data: [1,1,1,1,1], backgroundColor: ['#2196f3', '#4caf50', '#f44336', '#ff9800', '#9c27b0'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }

            if (ctx2) {
                revenueChart = new Chart(ctx2, {
                    type: 'line',
                    data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Revenue', data: [0,0,0,0,0,0], borderColor: '#2196f3', backgroundColor: 'rgba(33,150,243,0.1)', tension: 0.3 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } } }
                });
            }

            if (ctx3) {
                advocateChart = new Chart(ctx3, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Cases Handled', data: [], backgroundColor: '#ff9800' }] },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
                });
            }

            if (ctx4) {
                invoiceStatusChart = new Chart(ctx4, {
                    type: 'pie',
                    data: { labels: ['Paid', 'Issued', 'Draft', 'Overdue'], datasets: [{ data: [1,1,1,1], backgroundColor: ['#4caf50', '#2196f3', '#e0e0e0', '#f44336'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }
        }

        function updateCharts() {
            const statusCount = { ACTIVE: 0, WON: 0, LOST: 0, SETTLED: 0, CLOSED: 0 };
            allCases.forEach(c => { if (statusCount.hasOwnProperty(c.status)) statusCount[c.status]++; });

            if (caseStatusChart) {
                caseStatusChart.data.datasets[0].data = [statusCount.ACTIVE, statusCount.WON, statusCount.LOST, statusCount.SETTLED, statusCount.CLOSED];
                caseStatusChart.update();
            }

            const invoiceStatusCount = { PAID: 0, ISSUED: 0, DRAFT: 0, OVERDUE: 0 };
            allInvoices.forEach(i => { if (invoiceStatusCount.hasOwnProperty(i.status)) invoiceStatusCount[i.status]++; });

            if (invoiceStatusChart) {
                invoiceStatusChart.data.datasets[0].data = [invoiceStatusCount.PAID, invoiceStatusCount.ISSUED, invoiceStatusCount.DRAFT, invoiceStatusCount.OVERDUE];
                invoiceStatusChart.update();
            }

            const advocateNames = allAdvocates.slice(0, 5).map(a => a.name || 'Unknown');
            const advocateCases = advocateNames.map(name => allCases.filter(c => c.advocate?.name === name).length);

            if (advocateChart) {
                advocateChart.data.labels = advocateNames;
                advocateChart.data.datasets[0].data = advocateCases;
                advocateChart.update();
            }
        }

        function applyFilters() {
            loadAllData();
        }

        function exportReport() {
            const rows = [['Case #', 'Client', 'Status', 'Advocate', 'Date']];
            allCases.forEach(c => rows.push([c.caseNumber, c.client?.name || '—', c.status, c.advocate?.name || '—', new Date(c.createdAt).toLocaleDateString()]));
            
            let csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report_' + new Date().getTime() + '.csv';
            a.click();
        }

        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
    </script>
</body>
</html>
