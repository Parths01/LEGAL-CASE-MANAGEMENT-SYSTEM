<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Smart Legal CMS</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-body">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <i class="fas fa-balance-scale"></i>
            <h4>Legal CMS</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="admin-dashboard.html" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="cases.html"><i class="fas fa-folder-open"></i> Cases</a></li>
            <li><a href="advocates.html"><i class="fas fa-user-tie"></i> Advocates</a></li>
            <li><a href="clients.html"><i class="fas fa-users"></i> Clients</a></li>
            <li><a href="hearings.html"><i class="fas fa-gavel"></i> Hearings</a></li>
            <li><a href="documents.html"><i class="fas fa-file-alt"></i> Documents</a></li>
            <li><a href="invoices.html"><i class="fas fa-file-invoice-dollar"></i> Invoices</a></li>
            <li><a href="payments.html"><i class="fas fa-credit-card"></i> Payments</a></li>
            <li><a href="legal-notices.html"><i class="fas fa-envelope-open-text"></i> Legal Notices</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard <span id="refreshIndicator" style="font-size: 0.6rem; color: #4caf50; margin-left: 10px; display: none;"><i class="fas fa-sync-alt fa-spin"></i> Refreshing...</span></h1>
            <div class="user-info">
                <button class="btn btn-sm btn-outline-primary" onclick="manualRefresh()" style="margin-right: 15px;" title="Refresh Dashboard">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <div class="user-avatar">A</div>
                <div>
                    <strong id="userName">Admin</strong><br>
                    <small class="text-muted">Administrator</small>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="dashboard-card">
                    <div class="card-icon blue">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div class="stat-number" id="totalCases">0</div>
                    <div class="stat-label">Total Cases</div>
                    <a href="cases.html" class="card-footer-link">View All <i class="fas fa-arrow-right"></i></a>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="dashboard-card">
                    <div class="card-icon green">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-number" id="totalAdvocates">0</div>
                    <div class="stat-label">Advocates</div>
                    <a href="advocates.html" class="card-footer-link">View All <i class="fas fa-arrow-right"></i></a>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="dashboard-card">
                    <div class="card-icon purple">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number" id="totalClients">0</div>
                    <div class="stat-label">Clients</div>
                    <a href="clients.html" class="card-footer-link">View All <i class="fas fa-arrow-right"></i></a>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="dashboard-card">
                    <div class="card-icon orange">
                        <i class="fas fa-gavel"></i>
                    </div>
                    <div class="stat-number" id="pendingHearings">0</div>
                    <div class="stat-label">Pending Hearings</div>
                    <a href="hearings.html" class="card-footer-link">View All <i class="fas fa-arrow-right"></i></a>
                </div>
            </div>
        </div>

        <!-- Revenue Cards -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="dashboard-card">
                    <h5><i class="fas fa-dollar-sign"></i> Total Revenue</h5>
                    <div class="stat-number text-success" id="totalRevenue">₹0</div>
                    <small class="text-muted">From paid invoices</small>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="dashboard-card">
                    <h5><i class="fas fa-clock"></i> Pending Revenue</h5>
                    <div class="stat-number text-warning" id="pendingRevenue">₹0</div>
                    <small class="text-muted">From pending invoices</small>
                </div>
            </div>
        </div>

        <!-- Recent Cases Table -->
        <div class="data-table">
            <div class="table-header">
                <h3><i class="fas fa-folder-open"></i> Recent Cases</h3>
                <button class="btn-add" onclick="window.location.href='add-case.html'">
                    <i class="fas fa-plus"></i> Add New Case
                </button>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>Title</th>
                            <th>Client</th>
                            <th>Advocate</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="casesTableBody">
                        <tr>
                            <td colspan="6" class="text-center">Loading cases...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-bar"></i> Case Status Distribution</h5>
                    <canvas id="caseStatusChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line"></i> Monthly Revenue</h5>
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/nav.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let caseStatusChart;
        let revenueChart;

        if (!token) {
            window.location.href = 'login.html';
        }

        document.getElementById('userName').textContent = localStorage.getItem('userName') || 'Admin';

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        const formatCurrency = (value) => `₹${Number(value || 0).toLocaleString('en-IN')}`;

        const normalizeStatus = (status) => {
            switch ((status || '').toUpperCase()) {
                case 'OPEN': return 'Open';
                case 'IN_PROGRESS': return 'In Progress';
                case 'CLOSED': return 'Closed';
                case 'WON': return 'Won';
                case 'LOST': return 'Lost';
                case 'SETTLED': return 'Settled';
                default: return status || 'Unknown';
            }
        };

        const escapeHtml = (value) => {
            const div = document.createElement('div');
            div.textContent = value ?? '';
            return div.innerHTML;
        };

        async function loadDashboard() {
            await Promise.all([loadDashboardStats(), loadRecentCases()]);
        }

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard/admin/stats', {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load dashboard stats');
                }

                const payload = await response.json();
                const stats = payload.data || {};

                document.getElementById('totalCases').textContent = stats.totalCases ?? 0;
                document.getElementById('totalAdvocates').textContent = stats.totalAdvocates ?? 0;
                document.getElementById('totalClients').textContent = stats.totalClients ?? 0;
                document.getElementById('pendingHearings').textContent = stats.pendingHearings ?? 0;
                document.getElementById('totalRevenue').textContent = formatCurrency(stats.totalRevenue);
                document.getElementById('pendingRevenue').textContent = formatCurrency(stats.pendingRevenue);

                renderCaseStatusChart(stats.caseStatusDistribution || []);
                renderRevenueChart(stats.monthlyRevenue || []);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadRecentCases() {
            try {
                const response = await fetch('/api/cases', {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load cases');
                }

                const cases = await response.json();
                const tbody = document.getElementById('casesTableBody');

                if (!cases.length) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No cases found</td></tr>';
                    return;
                }

                cases.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                const recent = cases.slice(0, 5);

                tbody.innerHTML = recent.map(c => {
                    const status = normalizeStatus(c.status);
                    return `
                        <tr>
                            <td>${escapeHtml(c.caseNumber)}</td>
                            <td>${escapeHtml(c.caseTitle)}</td>
                            <td>${escapeHtml(c.client?.name || c.client?.user?.name || '—')}</td>
                            <td>${escapeHtml(c.advocate?.user?.name || '—')}</td>
                            <td>${escapeHtml(status)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='cases.html'">View</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading cases:', error);
                document.getElementById('casesTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Unable to load cases</td></tr>';
            }
        }

        function renderCaseStatusChart(rows) {
            const labels = rows.map(r => normalizeStatus(r.status));
            const data = rows.map(r => Number(r.total || 0));
            const ctx = document.getElementById('caseStatusChart').getContext('2d');

            if (caseStatusChart) {
                caseStatusChart.destroy();
            }

            caseStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: ['#4facfe', '#43e97b', '#fa709a', '#f093fb', '#c4991f', '#9fa8da']
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderRevenueChart(rows) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const labels = rows.map(r => `${monthNames[(r.month || 1) - 1]} ${r.year}`);
            const data = rows.map(r => Number(r.total || 0));
            const ctx = document.getElementById('revenueChart').getContext('2d');

            if (revenueChart) {
                revenueChart.destroy();
            }

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Revenue (₹)',
                        data,
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.12)',
                        tension: 0.35,
                        fill: true
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function manualRefresh() {
            showRefreshIndicator();
            await loadDashboard();
            hideRefreshIndicator();
        }

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            if (indicator) indicator.style.display = 'inline';
        }

        function hideRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            if (indicator) {
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 1000);
            }
        }

        // Auto-refresh every 10 seconds for real-time data
        let refreshInterval;
        
        function startAutoRefresh() {
            refreshInterval = setInterval(async () => {
                showRefreshIndicator();
                await loadDashboard();
                hideRefreshIndicator();
            }, 10000); // 10 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        window.onload = () => {
            loadDashboard();
            startAutoRefresh();
        };

        // Stop refresh when page is hidden to save resources
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
