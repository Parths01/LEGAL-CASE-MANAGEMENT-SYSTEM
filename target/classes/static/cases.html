<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cases - Smart Legal CMS</title>
    <link rel="stylesheet" href="/assets/css/sidebar.css">
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>


    <div class="dashboard-container">
        <div class="main-content">
            <div class="page-header">
                <div>
                    <h1>Case Management</h1>
                    <p>Track, filter, and manage all legal cases in one place.</p>
                </div>
                <div class="d-flex" style="gap: 10px;" id="staffActions">
                    <button class="btn btn-outline" onclick="resetFilters()"><i class="fas fa-rotate"></i> Reset
                        Filters</button>
                    <button class="btn btn-primary" onclick="createNewCase()"><i class="fas fa-plus"></i> New
                        Case</button>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div>
                        <div class="label">Total Cases</div>
                        <div class="value" id="totalCases">0</div>
                    </div>
                    <div class="icon"><i class="fas fa-folder-open"></i></div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Active</div>
                        <div class="value" id="activeCases">0</div>
                    </div>
                    <div class="icon"><i class="fas fa-gavel"></i></div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Upcoming Hearings</div>
                        <div class="value" id="upcomingHearings">0</div>
                    </div>
                    <div class="icon"><i class="fas fa-calendar-day"></i></div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Overdue Tasks</div>
                        <div class="value" id="overdueTasks">0</div>
                    </div>
                    <div class="icon"><i class="fas fa-triangle-exclamation"></i></div>
                </div>
            </div>

            <div class="card">
                <div class="filters">
                    <input type="text" id="searchInput" placeholder="Search by case ID, title, client, or advocate"
                        oninput="applyFilters()">
                    <select id="statusFilter" onchange="applyFilters()">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Escalated">Escalated</option>
                        <option value="Closed">Closed</option>
                    </select>
                    <select id="priorityFilter" onchange="applyFilters()">
                        <option value="">All Priority</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="categoryFilter" onchange="applyFilters()">
                        <option value="">All Categories</option>
                        <option value="Civil">Civil</option>
                        <option value="Criminal">Criminal</option>
                        <option value="Corporate">Corporate</option>
                        <option value="Family">Family</option>
                        <option value="Property">Property</option>
                    </select>
                    <select id="sortFilter" onchange="applyFilters()">
                        <option value="nextHearing">Sort: Next Hearing</option>
                        <option value="priority">Sort: Priority</option>
                        <option value="status">Sort: Status</option>
                        <option value="client">Sort: Client</option>
                    </select>
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Case ID</th>
                                <th>Title</th>
                                <th>Client</th>
                                <th>Advocate</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Next Hearing</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="casesTableBody"></tbody>
                    </table>
                </div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px; color: #94a3b8;"></i>
                    <p>No cases match your filters.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cases = [];

        const priorityRank = { High: 1, Medium: 2, Low: 3 };
        const statusRank = { Escalated: 1, Active: 2, Pending: 3, Closed: 4 };

        function formatDate(dateStr) {
            if (!dateStr) return "N/A";
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return "N/A";
            return date.toLocaleDateString("en-IN", { day: "2-digit", month: "short", year: "numeric" });
        }

        function updateStats(list) {
            const total = list.length;
            const active = list.filter(c => c.status === "Active").length;
            const upcoming = list.filter(c => new Date(c.nextHearing) >= new Date()).length;
            const overdue = list.reduce((sum, c) => sum + (c.overdueTasks || 0), 0);
            document.getElementById("totalCases").textContent = total;
            document.getElementById("activeCases").textContent = active;
            document.getElementById("upcomingHearings").textContent = upcoming;
            document.getElementById("overdueTasks").textContent = overdue;
        }

        function getBadgeClass(value, type) {
            if (type === "status") {
                if (value === "Active") return "status-badge status-active";
                if (value === "Pending") return "status-badge status-pending";
                if (value === "Escalated") return "status-badge status-escalated";
                return "status-badge status-closed";
            }
            if (value === "High") return "priority-badge priority-high";
            if (value === "Medium") return "priority-badge priority-medium";
            return "priority-badge priority-low";
        }

        function renderTable(list) {
            const tbody = document.getElementById("casesTableBody");
            const emptyState = document.getElementById("emptyState");
            const isClient = (localStorage.getItem('userRole') || '').toUpperCase() === 'CLIENT';
            tbody.innerHTML = "";

            if (!list.length) {
                emptyState.style.display = "block";
                return;
            }
            emptyState.style.display = "none";

            list.forEach(item => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.caseNumber}</td>
                    <td>${item.title}</td>
                    <td>${item.client}</td>
                    <td>${item.advocate}</td>
                    <td>${item.category}</td>
                    <td><span class="${getBadgeClass(item.status, "status")}">${item.status}</span></td>
                    <td><span class="${getBadgeClass(item.priority, "priority")}">${item.priority}</span></td>
                    <td>${formatDate(item.nextHearing)}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-outline btn-sm" onclick="viewCase('${item.caseNumber}')"><i class="fas fa-eye"></i></button>
                            ${!isClient ? `<button class="btn btn-primary btn-sm" onclick="editCase('${item.caseNumber}')"><i class="fas fa-pen"></i></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function toDateValue(dateStr) {
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? Number.MAX_SAFE_INTEGER : date.getTime();
        }

        function applyFilters() {
            const query = document.getElementById("searchInput").value.toLowerCase();
            const status = document.getElementById("statusFilter").value;
            const priority = document.getElementById("priorityFilter").value;
            const category = document.getElementById("categoryFilter").value;
            const sort = document.getElementById("sortFilter").value;

            let filtered = cases.filter(c => {
                const matchesQuery = [c.caseNumber, c.title, c.client, c.advocate]
                    .some(field => field.toLowerCase().includes(query));
                const matchesStatus = status ? c.status === status : true;
                const matchesPriority = priority ? c.priority === priority : true;
                const matchesCategory = category ? c.category === category : true;
                return matchesQuery && matchesStatus && matchesPriority && matchesCategory;
            });

            filtered = filtered.sort((a, b) => {
                if (sort === "priority") return priorityRank[a.priority] - priorityRank[b.priority];
                if (sort === "status") return statusRank[a.status] - statusRank[b.status];
                if (sort === "client") return a.client.localeCompare(b.client);
                return toDateValue(a.nextHearing) - toDateValue(b.nextHearing);
            });

            renderTable(filtered);
            updateStats(filtered);
        }

        function resetFilters() {
            document.getElementById("searchInput").value = "";
            document.getElementById("statusFilter").value = "";
            document.getElementById("priorityFilter").value = "";
            document.getElementById("categoryFilter").value = "";
            document.getElementById("sortFilter").value = "nextHearing";
            applyFilters();
        }

        function createNewCase() {
            window.location.href = 'create-case.html';
        }

        function viewCase(caseId) {
            window.location.href = `case-details.html?id=${caseId}&from=cases`;
        }

        function editCase(caseId) {
            window.location.href = `case-details.html?id=${caseId}&from=cases`;
        }

        function logout() {
            localStorage.clear();
            window.location.href = "login.html";
        }

        function checkAuthorization() {
            const role = (localStorage.getItem('userRole') || '').trim().toUpperCase();
            if (!role) {
                window.location.href = 'login.html';
                return false;
            }
            if (!['ADMIN', 'CLERK', 'ADVOCATE', 'CLIENT'].includes(role)) {
                alert('Unauthorized access.');
                window.location.href = 'login.html';
                return false;
            }
            // Hide staff-only actions for clients
            if (role === 'CLIENT') {
                const staffActions = document.getElementById('staffActions');
                if (staffActions) staffActions.style.display = 'none';
            }
            return true;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
            toast.innerHTML = `<i class="fas fa-${icon}" style="font-size: 1.2rem; color: var(--${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}-color);"></i><span>${message}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function loadCases() {
            try {
                const role = localStorage.getItem('userRole');
                const userId = localStorage.getItem('userId');
                const params = new URLSearchParams();
                if (role) params.append('role', role);
                if (userId) params.append('userId', userId);
                const response = await fetch(`/api/cases?${params.toString()}`);
                if (!response.ok) {
                    throw new Error('Failed to load cases');
                }
                const data = await response.json();
                cases = data.map(item => ({
                    caseNumber: item.caseNumber,
                    title: item.title,
                    client: item.client,
                    advocate: item.advocate,
                    category: item.category,
                    status: item.status,
                    priority: item.priority,
                    nextHearing: item.nextHearing,
                    overdueTasks: item.overdueTasks || 0
                }));
                applyFilters();
            } catch (error) {
                console.error(error);
                showToast('Unable to load cases', 'error');
                applyFilters();
            }
        }

        if (checkAuthorization()) {
            loadCases();
        }
    </script>
    <script src="/assets/js/sidebar.js"></script>
</body>

</html>