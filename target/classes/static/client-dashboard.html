<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Dashboard - Smart Legal CMS</title>
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="assets/css/dashboard.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="dashboard-body">
  <div class="sidebar">
    <div class="sidebar-logo">
      <i class="fas fa-balance-scale"></i>
      <h4>Legal CMS</h4>
    </div>
    <ul class="sidebar-menu">
      <!-- Populated by nav.js based on userRole -->
    </ul>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <h1><i class="fas fa-user"></i> Client Dashboard</h1>
      <div class="user-info">
        <div class="user-avatar">C</div>
        <div>
          <strong id="userName">Client</strong><br>
          <small class="text-muted">Client</small>
        </div>
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <div class="row" style="margin-top: 10px;">
      <div class="col-md-3 mb-3">
        <div class="dashboard-card">
          <div class="card-icon blue"><i class="fas fa-folder-open"></i></div>
          <div class="stat-number" id="caseCount">0</div>
          <div class="stat-label">My Cases</div>
          <a href="cases.html" class="card-footer-link">View Cases <i class="fas fa-arrow-right"></i></a>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="dashboard-card">
          <div class="card-icon green"><i class="fas fa-file-alt"></i></div>
          <div class="stat-number" id="documentCount">0</div>
          <div class="stat-label">Documents</div>
          <a href="documents.html" class="card-footer-link">View Documents <i class="fas fa-arrow-right"></i></a>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="dashboard-card">
          <div class="card-icon orange"><i class="fas fa-file-invoice-dollar"></i></div>
          <div class="stat-number" id="invoiceCount">0</div>
          <div class="stat-label">Invoices</div>
          <a href="invoices.html" class="card-footer-link">View Invoices <i class="fas fa-arrow-right"></i></a>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="dashboard-card">
          <div class="card-icon purple"><i class="fas fa-credit-card"></i></div>
          <div class="stat-number" id="paymentPending">0</div>
          <div class="stat-label">Payments Pending</div>
          <a href="payments.html" class="card-footer-link">Make Payment <i class="fas fa-arrow-right"></i></a>
        </div>
      </div>
    </div>

    <div class="dashboard-card" id="welcomeCard">
      <h5><i class="fas fa-info-circle"></i> Welcome</h5>
      <p>Access your cases, documents, invoices, and payments from the menu. This dashboard will show your latest counts once data is loaded.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/nav.js"></script>
  <script>
    const token = localStorage.getItem('token');
    const userRole = (localStorage.getItem('userRole') || '').toUpperCase();

    if (!token) {
      window.location.href = 'login.html';
    }
    if (userRole && userRole !== 'CLIENT') {
      // Redirect non-clients back to their own dashboard
      switch (userRole) {
        case 'ADMIN': window.location.href = 'admin-dashboard.html'; return;
        case 'ADVOCATE': window.location.href = 'advocate-dashboard.html'; return;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadUserInfo();
      loadCounts();
    });

    function loadUserInfo() {
      const userName = localStorage.getItem('userName');
      if (userName) {
        document.getElementById('userName').textContent = userName;
        const avatar = document.querySelector('.user-avatar');
        if (avatar) avatar.textContent = userName.charAt(0).toUpperCase();
      }
    }

    async function loadCounts() {
      try {
        const headers = { 'Authorization': `Bearer ${token}` };
        const [casesRes, docsRes, invoicesRes] = await Promise.all([
          fetch('/api/cases', { headers }),
          fetch('/api/documents', { headers }),
          fetch('/api/invoices/client/list', { headers })
        ]);

        if ([casesRes.status, docsRes.status, invoicesRes.status].includes(401)) {
          logout();
          return;
        }

        const cases = casesRes.ok ? await casesRes.json() : [];
        const documents = docsRes.ok ? await docsRes.json() : [];
        const invoices = invoicesRes.ok ? await invoicesRes.json() : [];

        document.getElementById('caseCount').textContent = cases.length;
        document.getElementById('documentCount').textContent = documents.length;
        document.getElementById('invoiceCount').textContent = invoices.length;
        const pending = invoices.filter(i => (i.status || '').toUpperCase() === 'SENT' || (i.status || '').toUpperCase() === 'OVERDUE').length;
        document.getElementById('paymentPending').textContent = pending;
      } catch (err) {
        console.error('Failed to load client dashboard data', err);
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'login.html';
    }
  </script>
</body>
</html>
