<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cases Management - Smart Legal CMS</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .case-table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex: 1;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            padding: 10px 15px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #0b1c2d;
            box-shadow: 0 0 0 3px rgba(11, 28, 45, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-width: 150px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #0b1c2d;
            box-shadow: 0 0 0 3px rgba(11, 28, 45, 0.1);
        }

        .btn-add-case {
            background: linear-gradient(135deg, #0b1c2d, #1a3a52);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-add-case:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(11, 28, 45, 0.3);
        }

        .cases-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .cases-table thead {
            background: linear-gradient(135deg, #0b1c2d, #1a3a52);
            color: white;
        }

        .cases-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .cases-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .cases-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .cases-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .cases-table tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }

        .cases-table td {
            padding: 15px 12px;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .status-open { background: #e3f2fd; color: #1976d2; }
        .status-in_progress { background: #fff3e0; color: #f57c00; }
        .status-closed { background: #f3e5f5; color: #7b1fa2; }
        .status-won { background: #e8f5e9; color: #388e3c; }
        .status-lost { background: #ffebee; color: #d32f2f; }
        .status-settled { background: #e0f2f1; color: #00796b; }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .priority-low { background: #e8f5e9; color: #2e7d32; }
        .priority-medium { background: #fff3e0; color: #f57c00; }
        .priority-high { background: #ffe0b2; color: #ef6c00; }
        .priority-urgent { background: #ffebee; color: #c62828; }

        .case-type-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            background: #f5f5f5;
            color: #555;
            display: inline-block;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .btn-view { background: #2196f3; color: white; }
        .btn-view:hover { background: #1976d2; }

        .btn-edit { background: #ff9800; color: white; }
        .btn-edit:hover { background: #f57c00; }

        .btn-delete { background: #f44336; color: white; }
        .btn-delete:hover { background: #d32f2f; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ddd;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #0b1c2d;
            color: white;
            border-color: #0b1c2d;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #0b1c2d;
            color: white;
            border-color: #0b1c2d;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border: none;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #0b1c2d, #1a3a52);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .close:hover {
            color: #d4af37;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group label .required {
            color: #f44336;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0b1c2d;
            box-shadow: 0 0 0 3px rgba(11, 28, 45, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-modal {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-modal-primary {
            background: linear-gradient(135deg, #0b1c2d, #1a3a52);
            color: white;
        }

        .btn-modal-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(11, 28, 45, 0.3);
        }

        .btn-modal-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-modal-secondary:hover {
            background: #5a6268;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.blue { background: linear-gradient(135deg, #2196f3, #1976d2); color: white; }
        .stat-icon.orange { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; }
        .stat-icon.green { background: linear-gradient(135deg, #4caf50, #388e3c); color: white; }
        .stat-icon.purple { background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; }

        .stat-info h3 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .stat-info p {
            margin: 0;
            color: #777;
            font-size: 0.9rem;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0b1c2d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-filter-group {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="dashboard-body">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <i class="fas fa-balance-scale"></i>
            <h4>Legal CMS</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="admin-dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="cases.html" class="active"><i class="fas fa-folder-open"></i> Cases</a></li>
            <li><a href="advocates.html"><i class="fas fa-user-tie"></i> Advocates</a></li>
            <li><a href="clients.html"><i class="fas fa-users"></i> Clients</a></li>
            <li><a href="hearings.html"><i class="fas fa-gavel"></i> Hearings</a></li>
            <li><a href="documents.html"><i class="fas fa-file-alt"></i> Documents</a></li>
            <li><a href="invoices.html"><i class="fas fa-file-invoice-dollar"></i> Invoices</a></li>
            <li><a href="payments.html"><i class="fas fa-credit-card"></i> Payments</a></li>
            <li><a href="legal-notices.html"><i class="fas fa-envelope-open-text"></i> Legal Notices</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1><i class="fas fa-folder-open"></i> Cases Management</h1>
            <div class="user-info">
                <div class="user-avatar">A</div>
                <div>
                    <strong id="userName">Admin</strong><br>
                    <small class="text-muted">Administrator</small>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-folder-open"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalCases">0</h3>
                    <p>Total Cases</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="fas fa-spinner"></i>
                </div>
                <div class="stat-info">
                    <h3 id="activeCases">0</h3>
                    <p>Active Cases</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="wonCases">0</h3>
                    <p>Won Cases</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple">
                    <i class="fas fa-handshake"></i>
                </div>
                <div class="stat-info">
                    <h3 id="settledCases">0</h3>
                    <p>Settled Cases</p>
                </div>
            </div>
        </div>

        <!-- Cases Table -->
        <div class="case-table-container">
            <div class="table-header">
                <div class="search-filter-group">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search by case number, title, or client...">
                    </div>
                    <select class="filter-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="OPEN">Open</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="CLOSED">Closed</option>
                        <option value="WON">Won</option>
                        <option value="LOST">Lost</option>
                        <option value="SETTLED">Settled</option>
                    </select>
                    <select class="filter-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="CIVIL">Civil</option>
                        <option value="CRIMINAL">Criminal</option>
                        <option value="FAMILY">Family</option>
                        <option value="CORPORATE">Corporate</option>
                        <option value="TAX">Tax</option>
                        <option value="LABOUR">Labour</option>
                        <option value="PROPERTY">Property</option>
                        <option value="OTHER">Other</option>
                    </select>
                    <select class="filter-select" id="priorityFilter">
                        <option value="">All Priorities</option>
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                        <option value="URGENT">Urgent</option>
                    </select>
                </div>
                <button class="btn-add-case" onclick="openAddCaseModal()">
                    <i class="fas fa-plus"></i> Add New Case
                </button>
            </div>

            <div class="table-wrapper">
                <table class="cases-table" id="casesTable">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>Case Title</th>
                            <th>Type</th>
                            <th>Client</th>
                            <th>Advocate</th>
                            <th>Court</th>
                            <th>Filing Date</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="casesTableBody">
                        <tr>
                            <td colspan="10">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Loading cases...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- Add/Edit Case Modal -->
    <div id="caseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-folder-plus"></i> Add New Case</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="caseForm">
                    <input type="hidden" id="caseId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="caseNumber">Case Number <span class="required">*</span></label>
                            <input type="text" id="caseNumber" required placeholder="e.g., CIV/2024/001">
                        </div>
                        <div class="form-group">
                            <label for="caseType">Case Type <span class="required">*</span></label>
                            <select id="caseType" required>
                                <option value="">Select Type</option>
                                <option value="CIVIL">Civil</option>
                                <option value="CRIMINAL">Criminal</option>
                                <option value="FAMILY">Family</option>
                                <option value="CORPORATE">Corporate</option>
                                <option value="TAX">Tax</option>
                                <option value="LABOUR">Labour</option>
                                <option value="PROPERTY">Property</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="caseTitle">Case Title <span class="required">*</span></label>
                            <input type="text" id="caseTitle" required placeholder="Enter case title">
                        </div>
                        <div class="form-group">
                            <label for="clientId">Client <span class="required">*</span></label>
                            <select id="clientId" required>
                                <option value="">Select Client</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="advocateId">Advocate <span class="required">*</span></label>
                            <select id="advocateId" required>
                                <option value="">Select Advocate</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="courtType">Court Type</label>
                            <select id="courtType">
                                <option value="">Select Court Type</option>
                                <option value="SUPREME_COURT">Supreme Court</option>
                                <option value="HIGH_COURT">High Court</option>
                                <option value="DISTRICT_COURT">District Court</option>
                                <option value="TRIBUNAL">Tribunal</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="courtName">Court Name</label>
                            <input type="text" id="courtName" placeholder="Enter court name">
                        </div>
                        <div class="form-group">
                            <label for="filingDate">Filing Date</label>
                            <input type="date" id="filingDate">
                        </div>
                        <div class="form-group">
                            <label for="status">Status <span class="required">*</span></label>
                            <select id="status" required>
                                <option value="OPEN">Open</option>
                                <option value="IN_PROGRESS">In Progress</option>
                                <option value="CLOSED">Closed</option>
                                <option value="WON">Won</option>
                                <option value="LOST">Lost</option>
                                <option value="SETTLED">Settled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="priority">Priority <span class="required">*</span></label>
                            <select id="priority" required>
                                <option value="LOW">Low</option>
                                <option value="MEDIUM" selected>Medium</option>
                                <option value="HIGH">High</option>
                                <option value="URGENT">Urgent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="opposingParty">Opposing Party</label>
                            <input type="text" id="opposingParty" placeholder="Enter opposing party name">
                        </div>
                        <div class="form-group">
                            <label for="judgeName">Judge Name</label>
                            <input type="text" id="judgeName" placeholder="Enter judge name">
                        </div>
                        <div class="form-group full-width">
                            <label for="description">Case Description</label>
                            <textarea id="description" placeholder="Enter detailed case description..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn-modal btn-modal-primary" onclick="saveCase()">
                    <i class="fas fa-save"></i> Save Case
                </button>
            </div>
        </div>
    </div>

    <!-- View Case Modal -->
    <div id="viewCaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-eye"></i> Case Details</h2>
                <span class="close" onclick="closeViewModal()">&times;</span>
            </div>
            <div class="modal-body" id="caseDetails">
                <!-- Case details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-secondary" onclick="closeViewModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let allCases = [];
        let filteredCases = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let clients = [];
        let advocates = [];
        const token = localStorage.getItem('token');

        // Check authentication
        if (!token) {
            window.location.href = 'login.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadClients();
            loadAdvocates();
            loadCases();
            setupEventListeners();
        });

        // Load user information
        function loadUserInfo() {
            const userName = localStorage.getItem('userName');
            if (userName) {
                document.getElementById('userName').textContent = userName;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterCases);
            document.getElementById('statusFilter').addEventListener('change', filterCases);
            document.getElementById('typeFilter').addEventListener('change', filterCases);
            document.getElementById('priorityFilter').addEventListener('change', filterCases);
        }

        // Load clients for dropdown
        async function loadClients() {
            try {
                const response = await fetch('/api/clients', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    clients = await response.json();
                    const clientSelect = document.getElementById('clientId');
                    clientSelect.innerHTML = '<option value="">Select Client</option>';
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.clientId;
                        option.textContent = client.user?.name || `Client #${client.clientId}`;
                        clientSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        // Load advocates for dropdown
        async function loadAdvocates() {
            try {
                const response = await fetch('/api/advocates', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    advocates = await response.json();
                    const advocateSelect = document.getElementById('advocateId');
                    advocateSelect.innerHTML = '<option value="">Select Advocate</option>';
                    advocates.forEach(advocate => {
                        const option = document.createElement('option');
                        option.value = advocate.advocateId;
                        option.textContent = advocate.user?.name || `Advocate #${advocate.advocateId}`;
                        advocateSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading advocates:', error);
            }
        }

        // Load cases from API
        async function loadCases() {
            try {
                const response = await fetch('/api/cases', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    allCases = await response.json();
                    filteredCases = [...allCases];
                    updateStatistics();
                    displayCases();
                } else if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                } else {
                    showEmptyState('Failed to load cases');
                }
            } catch (error) {
                console.error('Error loading cases:', error);
                showEmptyState('Error loading cases. Please try again.');
            }
        }

        // Update statistics
        function updateStatistics() {
            document.getElementById('totalCases').textContent = allCases.length;
            document.getElementById('activeCases').textContent = 
                allCases.filter(c => c.status === 'OPEN' || c.status === 'IN_PROGRESS').length;
            document.getElementById('wonCases').textContent = 
                allCases.filter(c => c.status === 'WON').length;
            document.getElementById('settledCases').textContent = 
                allCases.filter(c => c.status === 'SETTLED').length;
        }

        // Filter cases
        function filterCases() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;

            filteredCases = allCases.filter(caseItem => {
                const matchesSearch = 
                    caseItem.caseNumber.toLowerCase().includes(searchTerm) ||
                    caseItem.caseTitle.toLowerCase().includes(searchTerm) ||
                    (caseItem.client?.user?.name || '').toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || caseItem.status === statusFilter;
                const matchesType = !typeFilter || caseItem.caseType === typeFilter;
                const matchesPriority = !priorityFilter || caseItem.priority === priorityFilter;

                return matchesSearch && matchesStatus && matchesType && matchesPriority;
            });

            currentPage = 1;
            displayCases();
        }

        // Display cases in table
        function displayCases() {
            const tbody = document.getElementById('casesTableBody');
            
            if (filteredCases.length === 0) {
                showEmptyState('No cases found');
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const casesToDisplay = filteredCases.slice(startIndex, endIndex);

            tbody.innerHTML = casesToDisplay.map(caseItem => `
                <tr>
                    <td><strong>${escapeHtml(caseItem.caseNumber)}</strong></td>
                    <td>${escapeHtml(caseItem.caseTitle)}</td>
                    <td><span class="case-type-badge">${formatCaseType(caseItem.caseType)}</span></td>
                    <td>${escapeHtml(caseItem.client?.user?.name || 'N/A')}</td>
                    <td>${escapeHtml(caseItem.advocate?.user?.name || 'N/A')}</td>
                    <td>${escapeHtml(caseItem.courtName || 'N/A')}</td>
                    <td>${formatDate(caseItem.filingDate)}</td>
                    <td><span class="status-badge status-${caseItem.status.toLowerCase()}">${formatStatus(caseItem.status)}</span></td>
                    <td><span class="priority-badge priority-${caseItem.priority.toLowerCase()}">${formatPriority(caseItem.priority)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="viewCase(${caseItem.caseId})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-edit" onclick="editCase(${caseItem.caseId})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteCase(${caseItem.caseId})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            setupPagination();
        }

        // Setup pagination
        function setupPagination() {
            const totalPages = Math.ceil(filteredCases.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<span>...</span>';
                }
            }

            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredCases.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayCases();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Show empty state
        function showEmptyState(message) {
            const tbody = document.getElementById('casesTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="10">
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h3>${message}</h3>
                            <p>Try adjusting your filters or add a new case to get started.</p>
                        </div>
                    </td>
                </tr>
            `;
            document.getElementById('pagination').innerHTML = '';
        }

        // Open add case modal
        function openAddCaseModal() {
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-folder-plus"></i> Add New Case';
            document.getElementById('caseForm').reset();
            document.getElementById('caseId').value = '';
            document.getElementById('caseModal').style.display = 'block';
        }

        // View case details
        async function viewCase(caseId) {
            try {
                const response = await fetch(`/api/cases/${caseId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const caseItem = await response.json();
                    displayCaseDetails(caseItem);
                    document.getElementById('viewCaseModal').style.display = 'block';
                } else {
                    alert('Failed to load case details');
                }
            } catch (error) {
                console.error('Error loading case details:', error);
                alert('Error loading case details');
            }
        }

        // Display case details
        function displayCaseDetails(caseItem) {
            const detailsHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Case Number</label>
                        <p><strong>${escapeHtml(caseItem.caseNumber)}</strong></p>
                    </div>
                    <div class="form-group">
                        <label>Case Type</label>
                        <p><span class="case-type-badge">${formatCaseType(caseItem.caseType)}</span></p>
                    </div>
                    <div class="form-group full-width">
                        <label>Case Title</label>
                        <p><strong>${escapeHtml(caseItem.caseTitle)}</strong></p>
                    </div>
                    <div class="form-group">
                        <label>Client</label>
                        <p>${escapeHtml(caseItem.client?.user?.name || 'N/A')}</p>
                    </div>
                    <div class="form-group">
                        <label>Advocate</label>
                        <p>${escapeHtml(caseItem.advocate?.user?.name || 'N/A')}</p>
                    </div>
                    <div class="form-group">
                        <label>Court Type</label>
                        <p>${formatCourtType(caseItem.courtType)}</p>
                    </div>
                    <div class="form-group">
                        <label>Court Name</label>
                        <p>${escapeHtml(caseItem.courtName || 'N/A')}</p>
                    </div>
                    <div class="form-group">
                        <label>Filing Date</label>
                        <p>${formatDate(caseItem.filingDate)}</p>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <p><span class="status-badge status-${caseItem.status.toLowerCase()}">${formatStatus(caseItem.status)}</span></p>
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <p><span class="priority-badge priority-${caseItem.priority.toLowerCase()}">${formatPriority(caseItem.priority)}</span></p>
                    </div>
                    <div class="form-group">
                        <label>Opposing Party</label>
                        <p>${escapeHtml(caseItem.opposingParty || 'N/A')}</p>
                    </div>
                    <div class="form-group">
                        <label>Judge Name</label>
                        <p>${escapeHtml(caseItem.judgeName || 'N/A')}</p>
                    </div>
                    <div class="form-group full-width">
                        <label>Description</label>
                        <p>${escapeHtml(caseItem.description || 'No description provided')}</p>
                    </div>
                    <div class="form-group">
                        <label>Created At</label>
                        <p>${formatDateTime(caseItem.createdAt)}</p>
                    </div>
                    <div class="form-group">
                        <label>Last Updated</label>
                        <p>${formatDateTime(caseItem.updatedAt)}</p>
                    </div>
                </div>
            `;
            document.getElementById('caseDetails').innerHTML = detailsHTML;
        }

        // Edit case
        async function editCase(caseId) {
            try {
                const response = await fetch(`/api/cases/${caseId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const caseItem = await response.json();
                    populateFormForEdit(caseItem);
                    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Case';
                    document.getElementById('caseModal').style.display = 'block';
                } else {
                    alert('Failed to load case for editing');
                }
            } catch (error) {
                console.error('Error loading case:', error);
                alert('Error loading case');
            }
        }

        // Populate form for editing
        function populateFormForEdit(caseItem) {
            document.getElementById('caseId').value = caseItem.caseId;
            document.getElementById('caseNumber').value = caseItem.caseNumber;
            document.getElementById('caseTitle').value = caseItem.caseTitle;
            document.getElementById('caseType').value = caseItem.caseType;
            document.getElementById('clientId').value = caseItem.client?.clientId || '';
            document.getElementById('advocateId').value = caseItem.advocate?.advocateId || '';
            document.getElementById('courtType').value = caseItem.courtType || '';
            document.getElementById('courtName').value = caseItem.courtName || '';
            document.getElementById('filingDate').value = caseItem.filingDate || '';
            document.getElementById('status').value = caseItem.status;
            document.getElementById('priority').value = caseItem.priority;
            document.getElementById('opposingParty').value = caseItem.opposingParty || '';
            document.getElementById('judgeName').value = caseItem.judgeName || '';
            document.getElementById('description').value = caseItem.description || '';
        }

        // Save case
        async function saveCase() {
            const caseId = document.getElementById('caseId').value;
            const formData = {
                caseNumber: document.getElementById('caseNumber').value,
                caseTitle: document.getElementById('caseTitle').value,
                caseType: document.getElementById('caseType').value,
                client: { clientId: parseInt(document.getElementById('clientId').value) },
                advocate: { advocateId: parseInt(document.getElementById('advocateId').value) },
                courtType: document.getElementById('courtType').value || null,
                courtName: document.getElementById('courtName').value || null,
                filingDate: document.getElementById('filingDate').value || null,
                status: document.getElementById('status').value,
                priority: document.getElementById('priority').value,
                opposingParty: document.getElementById('opposingParty').value || null,
                judgeName: document.getElementById('judgeName').value || null,
                description: document.getElementById('description').value || null
            };

            try {
                const url = caseId ? `/api/cases/${caseId}` : '/api/cases';
                const method = caseId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeModal();
                    loadCases();
                    alert(caseId ? 'Case updated successfully!' : 'Case created successfully!');
                } else {
                    const error = await response.text();
                    alert('Failed to save case: ' + error);
                }
            } catch (error) {
                console.error('Error saving case:', error);
                alert('Error saving case');
            }
        }

        // Delete case
        async function deleteCase(caseId) {
            if (!confirm('Are you sure you want to delete this case? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/cases/${caseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    loadCases();
                    alert('Case deleted successfully!');
                } else {
                    alert('Failed to delete case');
                }
            } catch (error) {
                console.error('Error deleting case:', error);
                alert('Error deleting case');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('caseModal').style.display = 'none';
        }

        // Close view modal
        function closeViewModal() {
            document.getElementById('viewCaseModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('caseModal');
            const viewModal = document.getElementById('viewCaseModal');
            if (event.target === modal) {
                closeModal();
            }
            if (event.target === viewModal) {
                closeViewModal();
            }
        }

        // Format functions
        function formatStatus(status) {
            return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatPriority(priority) {
            return priority.charAt(0).toUpperCase() + priority.slice(1).toLowerCase();
        }

        function formatCaseType(type) {
            return type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatCourtType(type) {
            if (!type) return 'N/A';
            return type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            return new Date(date).toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(dateTime) {
            if (!dateTime) return 'N/A';
            return new Date(dateTime).toLocaleString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userName');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
